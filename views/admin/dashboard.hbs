<section class="shop">
  <div class="container shop-inner">
    <h2 class="shop-title">Dashboard do Administrador</h2>
    <div class="shop-topbar">
      <button type="button" class="btn" id="refreshOrdersBtn">Atualizar status dos pedidos</button>
      <span id="refreshMsg"></span>
      <div class="form-field" style="margin-left:12px;display:inline-block;vertical-align:middle;">
        <span>Confirmar manualmente (ID do pedido)</span>
        <input type="number" id="approveOrderId" class="insc-input" style="width:140px;" placeholder="ex.: 123"/>
        <button type="button" class="btn" id="approveOrderBtn">Confirmar pagamento</button>
        <span id="approveMsg"></span>
      </div>
    </div>
    <div class="feature-list">
      <a class="feature-item" href="/admin/inscricoes">
        <div class="feature-title">Inscrições</div>
        <p class="feature-desc">Total: {{inscCount}}</p>
      </a>
      <a class="feature-item" href="/admin/pedidos">
        <div class="feature-title">Pedidos da loja</div>
        <p class="feature-desc">Total de pedidos pagos: {{ordersCount}} • Recebido líquido: {{ordersNetBRL}}</p>
      </a>
      <a class="feature-item" href="/admin/doacoes">
        <div class="feature-title">Doações</div>
        <p class="feature-desc">Total: {{donationsCount}}</p>
      </a>
      <a class="feature-item" href="/admin/admins/new">
        <div class="feature-title">Criar novo administrador</div>
        <p class="feature-desc">Adicionar acesso administrativo</p>
      </a>
      
    </div>
  </div>
</section>
<script>
(function(){
  const btn = document.getElementById('refreshOrdersBtn');
  const msg = document.getElementById('refreshMsg');
  const approveBtn = document.getElementById('approveOrderBtn');
  const approveId = document.getElementById('approveOrderId');
  const approveMsg = document.getElementById('approveMsg');
  function setMsg(t){ if(msg) { msg.textContent = t; } }
  function setApproveMsg(t){ if(approveMsg){ approveMsg.textContent = t; } }
  if (btn) {
    btn.addEventListener('click', async () => {
      try {
        setMsg('Atualizando...');
        const r = await fetch('/admin/pedidos/refresh');
        const data = await r.json();
        if (!data.ok) { setMsg('Falha ao atualizar'); return; }
        setMsg(`Verificados: ${data.checked}, atualizados: ${data.updated}, aprovados: ${data.approved}`);
      } catch { setMsg('Erro de rede'); }
    });
  }
  if (approveBtn && approveId) {
    approveBtn.addEventListener('click', async () => {
      const id = Number(approveId.value || 0);
      if (!id) { setApproveMsg('Informe o ID'); return; }
      try {
        setApproveMsg('Confirmando...');
        const r = await fetch(`/admin/pedidos/approve/${id}`);
        const data = await r.json();
        if (!data.ok) { setApproveMsg('Falha ao confirmar'); return; }
        setApproveMsg('Confirmado');
      } catch { setApproveMsg('Erro de rede'); }
    });
  }
})();
</script>
